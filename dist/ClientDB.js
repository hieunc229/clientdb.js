!function(){var e={};Object.defineProperty(e,"__esModule",{value:!0}),e.default=function(e){let t,r=[];return Object.keys(e).forEach(n=>{switch(typeof(t=e[n])){case"string":case"number":case"boolean":r.push({property:n,eq:t});break;case"object":Array.isArray(t)?r.push({property:n,range:{from:t[0],to:t[1]}}):r.push(Object.assign({property:n},t));break;default:throw Error(`Unable to parse query "${t}"`)}}),r};var t={},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const n=r(e);t.default=class{constructor(e){this.m_max=-1,this.m_page=-1,this.orders=[],this.openDB=e.openDB,this.queries=n.default(e.queries),this.collection=e.collection}_openCursor(e,t,r){return new Promise((n,s)=>{let o=t.index(e).openCursor(r);o.onsuccess=(e=>n(e.target.result)),o.onerror=(e=>s(e))})}_openCursorMultipleRange(e,t,r,n){return new Promise(function(s,o){var i=[],a=0,c=r.length;r.forEach(r=>{let o=t.index(e).openCursor(r);o.onsuccess=(e=>(function(e){a===c&&s(i),i=n(i,e)})(e.target.result)),o.onerror=(e=>(function(e){console.error(e)})(e))})})}sort(){return this.orders=Array.prototype.slice.call(arguments),this}max(e){return this.m_max=e,this}paging(e,t){return this.m_page=e,this.m_max=t,this}run(){let e=this;return new Promise((t,r)=>{let n=0,s=e.queries.length,o=[],i=[];function a(){var e=new Array(o.length),r=new Array(o.length),n=0;o.forEach(t=>{-1==e.indexOf(t._id)&&(r[n]=t,e[n++]=t.key)}),r.splice(n),t({items:r,errors:i})}this.openDB(t=>{let r=t.transaction(e.collection,"readonly").objectStore(e.collection);e.queries.forEach(t=>{var c;if(t.eq)c=IDBKeyRange.only(t.eq);else if(t.range)c=IDBKeyRange.bound(t.range.from,t.range.to);else if(t.gt)c=IDBKeyRange.upperBound(t.gt,!1);else if(t.gte)c=IDBKeyRange.upperBound(t.gt,!0);else if(t.lt)c=IDBKeyRange.lowerBound(t.lt,!1);else{if(!t.lte)throw Error(`Unable to parse ${t}`);c=IDBKeyRange.lowerBound(t.lte,!0)}e._openCursor(t.property,r,c).then(e=>(function(e){Array.isArray(e)?o=o.concat(e):o.push(e),++n===s&&a()})(e.value)).catch(e=>{!function(e){n++,i.push(e),n===s&&a()}({property:t.property,message:e.message})})})})})}};var s={};Object.defineProperty(s,"__esModule",{value:!0}),s.default=class{constructor(){this.events={change:[]},this.triggerOnChangeEvent=(e=>{this.events.change.forEach(t=>{t.callback(e)})})}getEvents(){return this.events}subscribe(e,t,r=!1){if(this.events[e]||(this.events[e]=[]),r){const r=this.events.find(e=>e.id===t.id);-1!==r&&this.events[e].splice(r,1)}this.events[e].push(t)}fire(e,t){const r=this.events[e];r&&r.length&&r.forEach(e=>{e.callback&&e.callback({changed:t})}),this.triggerOnChangeEvent({event:e,changed:t})}onChange(e){this.events.change.push(e)}};var o={},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(o,"__esModule",{value:!0});const a=i(s),c=i(t);o.default=class{constructor(e,t){this.openDB=t,this.ref=e,this.eventManager=new a.default}insert(e){let t=Array.isArray(e)?e:[e];var r=this;return new Promise((e,n)=>{r.openDB(s=>{var o,i=s.transaction(r.ref,"readwrite"),a=i.objectStore(r.ref);t.forEach(e=>{o=a.add(e)}),i.oncomplete=(r=>{e({items:t,changes:{inserted:t.length,updated:0,removed:0,unchange:0}})}),i.onerror=(e=>{n({items:t,message:o.error})})})})}remove(e){let t=Array.isArray(e)?e:[e],r=this;return new Promise((e,n)=>{r.openDB(s=>{let o,i,a=s.transaction([r.ref],"readwrite"),c=a.objectStore(r.ref);t.forEach(e=>{if(!(o="string"==typeof e?e:"object"==typeof e&&"_id"in e&&e._id))throw Error(`Unable to delete ${e}`);i=c.delete(o)}),a.oncomplete=(r=>{e({items:[],changes:{inserted:0,updated:0,removed:t.length,unchange:0}})}),a.onerror=(e=>{n({items:t,message:i.error})})})})}update(e,t){let r=this;return new Promise((n,s)=>{r.openDB(o=>{let i=o.transaction([r.ref],"readwrite").objectStore(r.ref),a=i.get(e);a.onsuccess=function(r){var o=r.target.result;if(o){Object.assign(o,t);var a=i.put(o);a.onerror=(e=>s(e)),a.onsuccess=(e=>n(e))}else s({message:`Record "${e}" not existed`})},a.onerror=(e=>s(e))})})}openCursor(e){this.openDB(t=>{t.transaction(this.ref,"readonly").objectStore(this.ref).openCursor().onsuccess=(t=>{e(t.target.result)})})}filter(e){return new c.default({queries:e,openDB:this.openDB.bind(this),collection:this.ref})}get(e){return new Promise((t,r)=>{this.openDB(n=>{var s=n.transaction(this.ref,"readonly").objectStore(this.ref).get(e);s.onsuccess=(e=>{t(e.target.result)}),s.onerror=(e=>{r({message:s.error})})})})}removeAllRecords(){return new Promise((e,t)=>{this.openDB(r=>{var n=r.transaction(this.ref,"readwrite").objectStore(this.ref),s=n.count(),o=n.clear();o.onsuccess=(t=>{e({items:[],changes:{removed:s,inserted:0,unchange:0,update:0}})}),o.onerror=(e=>{t({items:[],message:o.error,changes:{removed:0,inserted:0,unchange:0,update:s}})})})})}};var u={},l=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(u,"__esModule",{value:!0});const h=l(o),d="__clientdb_default";u.default=class{constructor(e){this.stores=[];var t=d,r=1,n=this._handleOpenFail.bind(this),s=this._handleOpenSuccess.bind(this);e&&(e.name&&(t=e.name),e.version&&(r=e.version),e.onerror&&(n=e.onerror),e.onsuccess&&(s=e.onsuccess)),this.options={name:t,version:r,onerror:n,onsuccess:s,stores:e.stores},this._init()}_handleOpenFail(e){console.error(e.errorCode,"Unable to open database")}_handleOpenSuccess(e){this.db=e.target.result}_handleStructureInitiate(e){if(e.target){var t=e.target.result;this.options.stores&&this.options.stores.forEach(r=>{let n;n=t.objectStoreNames.contains(r.name)?e.target.transaction.objectStore(r.name):t.createObjectStore(r.name,{keyPath:"_id"}),Object.keys(r.keys).forEach(e=>{n.indexNames.contains(e)||n.createIndex(e,e,{unique:r.keys[e]})})})}}_init(){let{name:e,version:t,onerror:r,stores:n}=this.options;var s=indexedDB.open(e||d,t);return r&&(s.onerror=r),s.onsuccess=this._handleOpenSuccess.bind(this),n&&(s.onupgradeneeded=this._handleStructureInitiate.bind(this)),this}open(e){let{name:t,version:r,onerror:n}=this.options;var s=indexedDB.open(t||d,r);n&&(s.onerror=n),s.onsuccess=(t=>{e(s.result)}),this.ref=s}collect(e){return new h.default(e,this.open.bind(this))}destroy(){indexedDB.deleteDatabase(this.options.name||d)}};var p={},f=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(p,"__esModule",{value:!0});const g=f(u);p.default=g.default;var m=p.default;window.ClientDB=m}();