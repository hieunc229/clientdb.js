!function(){var e={};Object.defineProperty(e,"__esModule",{value:!0}),e.default=function(e){let r,t=[];return Object.keys(e).forEach(s=>{switch(typeof(r=e[s])){case"string":case"number":case"boolean":t.push({property:s,eq:r});break;case"object":Array.isArray(r)?t.push({property:s,range:{from:r[0],to:r[1]}}):t.push(Object.assign({property:s},r));break;default:throw Error(`Unable to parse query "${r}"`)}}),t};var r={},t=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});const s=t(e);r.default=class{constructor(e){this.m_max=-1,this.m_page=-1,this.orders=[],this.openDB=e.openDB,this.queries=s.default(e.queries),this.collection=e.collection}_openCursor(e,r,t){return new Promise((s,n)=>{let o=r.index(e).openCursor(t);var i={errors:[],items:[]};o.onsuccess=(e=>{var r=e.target.result;r?(i.items.push(r.value),r.continue()):s(i)}),o.onerror=(e=>{var r=e.target.result;r?(i.errors.push(r.value),r.continue()):n(i)})})}_openCursorMultipleRange(e,r,t,s){return new Promise(function(n,o){var i=[],a=0,c=t.length;t.forEach(t=>{let o=r.index(e).openCursor(t);o.onsuccess=(e=>(function(e){a===c&&n(i),i=s(i,e)})(e.target.result)),o.onerror=(e=>(function(e){console.error(e)})(e))})})}sort(){return this.orders=Array.prototype.slice.call(arguments),this}max(e){return this.m_max=e,this}paging(e,r){return this.m_page=e,this.m_max=r,this}run(){let e=this;return new Promise((r,t)=>{this.openDB((s,n)=>{let o=[],i=[],a=s.transaction(e.collection,"readonly");a.oncomplete=(e=>{var t=new Array(o.length),s=new Array(o.length),a=0;o.forEach(e=>{-1==t.indexOf(e._id)&&(s[a]=e,t[a++]=e.key)}),s.splice(a),r({items:s,errors:i}),n()}),a.onerror=(e=>{t(i),n()}),a.onabort=(e=>{console.error("Transaction aborted"),n()});let c=a.objectStore(e.collection);e.queries.forEach(r=>{var t;if(r.eq)t=IDBKeyRange.only(r.eq);else if(r.range)t=IDBKeyRange.bound(r.range.from,r.range.to);else if(r.gt)t=IDBKeyRange.upperBound(r.gt,!1);else if(r.gte)t=IDBKeyRange.upperBound(r.gt,!0);else if(r.lt)t=IDBKeyRange.lowerBound(r.lt,!1);else{if(!r.lte)throw Error(`Unable to parse ${r}`);t=IDBKeyRange.lowerBound(r.lte,!0)}e._openCursor(r.property,c,t).then(e=>{Array.isArray(e.items)?o=o.concat(e.items):o.push(e.items)}).catch(e=>{i.push({property:r.property,message:e.message})})})})})}};var n={};Object.defineProperty(n,"__esModule",{value:!0}),n.default=class{constructor(){this.events={change:[]},this.triggerOnChangeEvent=(e=>{this.events.change.forEach(r=>{r.callback(e)})})}getEvents(){return this.events}subscribe(e,r,t=!1){if(this.events[e]||(this.events[e]=[]),t){const t=this.events.find(e=>e.id===r.id);-1!==t&&this.events[e].splice(t,1)}this.events[e].push(r)}fire(e,r){const t=this.events[e];t&&t.length&&t.forEach(t=>{t.callback&&t.callback(e,r)}),this.triggerOnChangeEvent({event:e,changed:r})}onChange(e){this.events.change.push(e)}};var o={},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(o,"__esModule",{value:!0});const a=i(n),c=i(r);o.default=class{constructor(e,r){this.openDB=r,this.ref=e,this.eventManager=new a.default}insert(e){let r=Array.isArray(e)?e:[e];var t=this;return new Promise((e,s)=>{t.openDB((n,o)=>{var i=n.transaction(t.ref,"readwrite"),a=i.objectStore(t.ref),c=[],u=0;r.forEach(e=>{var r=a.add(e);r.onerror=(e=>{c.push(r.error)}),r.onsuccess=(e=>{u++})}),i.oncomplete=(s=>{var n={errors:c,items:r,changes:{inserted:u,updated:0,removed:0,unchange:r.length-u}};t.eventManager.fire("insert",n),e(n),o()}),i.onerror=(e=>{s({errors:c,items:r,message:i.error,changes:{inserted:u,updated:0,removed:0,unchange:r.length-u}}),o()})})})}remove(e){let r=[];r=Array.isArray(e)?e.map(e=>"string"==typeof e?e:e._id):"string"==typeof e?[e]:[e._id],Array.isArray(e);let t=this;return new Promise((e,s)=>{t.openDB((n,o)=>{let i,a=n.transaction([t.ref],"readwrite"),c=a.objectStore(t.ref);r.forEach(e=>{i=c.delete(e)}),a.oncomplete=(s=>{const n={items:r,changes:{inserted:0,updated:0,removed:r.length,unchange:0}};t.eventManager.fire("remove",n),e(n),o()}),a.onerror=(e=>{s({items:r,message:i.error})})})})}update(e,r){let t=this;return new Promise((s,n)=>{t.openDB((o,i)=>{let a=o.transaction([t.ref],"readwrite");var c=a.objectStore(t.ref);let u=c.get(e);a.oncomplete=(n=>{var o={items:[{id:e,changes:r}],changes:{updated:1,inserted:0,removed:0,unchange:0}};t.eventManager.fire("update",o),s(o),i()}),a.onerror=(e=>{n({error:u.error}),i()}),u.onsuccess=function(e){var t=e.target.result;if(t){Object.assign(t,r);var s=c.put(t);s.onerror=(e=>n(e)),s.onsuccess=(e=>{})}}})})}openCursor(){let e=this;return new Promise((r,t)=>{e.openDB((s,n)=>{var o=s.transaction(e.ref,"readonly"),i=o.objectStore(e.ref).openCursor();o.oncomplete=(e=>{n()}),o.onerror=(e=>{t({message:i.error}),n()}),i.onsuccess=(e=>{r({cursor:e.target.result,db:s,onComplete:n})}),i.onerror=(e=>{t({message:i.error})})})})}filter(e){return new c.default({queries:e,openDB:this.openDB.bind(this),collection:this.ref})}records(){let e=this;return new Promise((r,t)=>{e.openDB((s,n)=>{var o=s.transaction(e.ref,"readonly"),i=o.objectStore(e.ref).getAll();o.oncomplete=(e=>{n()}),o.onerror=(e=>{n()}),i.onsuccess=(e=>{let t=e.target.result;r(t)}),i.onerror=(e=>{t({message:i.error})})})})}get(e){let r=this;return new Promise((t,s)=>{r.openDB((n,o)=>{var i=n.transaction(r.ref,"readonly"),a=i.objectStore(r.ref).get(e);i.oncomplete=(e=>{o()}),a.onsuccess=(e=>{let r=e.target.result;t(r)}),a.onerror=(e=>{s({message:a.error})})})})}getAll(e){let r=this;return new Promise((t,s)=>{r.openDB((n,o)=>{var i=n.transaction(r.ref,"readonly"),a=i.objectStore(r.ref).openCursor();i.oncomplete=(e=>{o()});var c,u=[];a.onsuccess=(r=>{(c=r.target.result)?(-1!==e.indexOf(c.key)&&u.push(c.value),c.continue()):t(u)}),a.onerror=(e=>{s({message:a.error})})})})}removeAllRecords(){let e=this;return new Promise((r,t)=>{e.openDB((s,n)=>{var o=s.transaction(e.ref,"readwrite"),i=o.objectStore(e.ref),a=i.count(),c=i.clear();o.oncomplete=(e=>{n()}),c.onsuccess=(t=>{var s={items:[],changes:{removed:i.indexNames.length,inserted:0,unchange:0,update:0}};e.eventManager.fire("remove",s),r(s)}),c.onerror=(e=>{t({items:[],message:c.error,changes:{removed:0,inserted:0,unchange:0,update:a}})})})})}subscribe(e,r){this.eventManager.subscribe(e,{callback:r})}on(e,r){this.eventManager.subscribe(e,{callback:r})}};var u={},l=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(u,"__esModule",{value:!0});const h=l(o),d=l(n),p="__clientdb_default";u.default=class{constructor(e){this.stores={},this.__openConnections=0,this._handleOpenFail=(e=>{console.error(e.errorCode,this.request.error,"Unable to open database"),this.request=void 0}),this._handleOpenSuccess=(e=>{this.options.version=e.version,this.db=e,this.request=void 0,this.eventManager.fire("open",{db:e})}),this._handleStructureInitiate=(e=>{if(e.target){var r=e.target.result;if(this.options.stores){var t=e.target.transaction;t.oncomplete=(()=>{r.close()}),this.options.stores.forEach(e=>{let s;s=r.objectStoreNames.contains(e.name)?t.objectStore(e.name):r.createObjectStore(e.name,{keyPath:e.primaryKey||"_id"}),Object.keys(e.keys).forEach(r=>{s.indexNames.contains(r)||s.createIndex(r,r,{unique:e.keys[r].unique})})})}}}),this.isOpening=!1,this.closeConnection=(()=>{this.__openConnections--,0===this.__openConnections&&this.db&&(this.db.close(),this.db=void 0)}),this.open=(e=>{var r=!1;if(this.__openConnections++,this.db)e(this.db,this.closeConnection);else{let s=this;if(this.eventManager.subscribe("open",{callback:(t,n)=>{r||(s.db=n.db,e(s.db,this.closeConnection),r=!0)},once:!0}),!this.isOpening){let{name:e,onerror:r,onsuccess:s}=this.options,n=this.options.version>1?this.options.version:void 0;var t=indexedDB.open(e||p,n);this.request=t,t.onerror=function(e){r({message:t.error})},t.onsuccess=(e=>{this.isOpening=!1;let r=e.target.result;s(r),e.target.result.onversionchange=(()=>{r.close()})}),t.onupgradeneeded=this.onupgradeneeded,t.onblocked=(e=>{console.warn("Open DB blocked")})}}}),this.updateKeys=((e,r)=>{var t=this;return new Promise((s,n)=>{var o=indexedDB.open(t.options.name,t.options.version+1);t.request=o,o.onerror=function(e){n({message:o.error})},o.onblocked=(e=>{console.warn("Operation is blocked")}),o.onsuccess=(e=>{var r=e.target.result.version;this.options.version=r,s({version:r}),e.target.result.close()}),o.onupgradeneeded=function(t){let s=t.target.transaction.objectStore(e);s||n({message:`Collection ${e} not exists, use ".createStore(storeName, keys)" instead`}),Array.from(s.indexNames).forEach(e=>{r[e]||s.deleteIndex(e)}),Object.keys(r).forEach(e=>{s.indexNames.contains(e)||s.createIndex(e,e,{unique:r[e].unique})})}})}),this.onerror=(e=>{this.options.onerror(this.request.error)}),this.upgrade=(()=>{let e=indexedDB.open(this.options.name,this.options.version+1);this.request=e,e.onerror=this.onerror,e.onsuccess=this.onsuccess,e.onupgradeneeded=this.onupgradeneeded}),this.onsuccess=(e=>{let r=e.target.result;if(this.request=void 0,!this.options.allowUpdate)return this.options.allowUpdate=!1,void this.options.onsuccess(r);r.close();let t=this.options.stores,s=!1;t.some(e=>void 0===r.objectStoreNames[e]&&(s=!0,!0)),s||(s=t.length!=r.objectStoreNames.length),s&&this.upgrade()}),this.onupgradeneeded=(e=>{let r=e.target.result,t=this.options.stores,s=Array.from(r.objectStoreNames);1===r.version?t.forEach(e=>{let t=r.createObjectStore(e.name,{keyPath:e.primaryKey||"_id"});Object.keys(e.keys).forEach(r=>{t.indexNames.contains(r)||t.createIndex(r,r,{unique:e.keys[r].unique})})}):(t.forEach(e=>{if(s.find(r=>e.name===r)){let t=r.createObjectStore(e.name,{keyPath:e.primaryKey||"_id"});Object.keys(e.keys).forEach(r=>{t.indexNames.contains(r)||t.createIndex(r,r,{unique:e.keys[r].unique})})}}),s.forEach(e=>{-1===t.indexOf(e)&&r.deleteObjectStore(e)}))}),this.options=Object.assign({allowUpdate:!1,name:p,version:1,onerror:this._handleOpenFail,onsuccess:this._handleOpenSuccess},e),this.options.stores.forEach(e=>{this.stores[e.name]=new h.default(e.name,this.open.bind(this))}),this.eventManager=new d.default;var r=indexedDB.open(this.options.name);this.request=r,r.onerror=this.onerror,r.onsuccess=this.onsuccess,r.onupgradeneeded=this.onupgradeneeded}removeStore(e){var r=this;return new Promise((t,s)=>{r.open((n,o)=>{let{name:i,version:a}=r.options;var c=indexedDB.open(i||p,a+1);this.request=c,c.onerror=function(e){s(c.error),o()},c.onsuccess=(r=>{r.target.result.close(),delete this.stores[e],t(),o()}),c.onupgradeneeded=function(r){n.deleteObjectStore(e),o()}})})}createStore(e,r){var t=this;return new Promise((s,n)=>{let o=t.options.stores.find(r=>r.name===e);t.open((t,i)=>{var a=indexedDB.open(t.name,t.version+1);this.request=a,a.onerror=function(e){n(a.error),i()},a.onsuccess=(r=>{r.target.result.close(),this.stores[e]=new h.default(e,this.open.bind(this)),s(),i()}),a.onupgradeneeded=function(s){let n=t.createObjectStore(e,{keyPath:o.primaryKey||"_id"});Object.keys(r).forEach(e=>{n.createIndex(e,e,{unique:r[e].unique})}),i()}})})}collect(e){return this.stores[e]}destroy(){indexedDB.deleteDatabase(this.options.name||p)}};var g={},f=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(g,"__esModule",{value:!0});const m=f(u);g.default=m.default;var v=g.default;window.ClientDB=v}();