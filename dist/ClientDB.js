!function(){var e={};Object.defineProperty(e,"__esModule",{value:!0}),e.default=function(e){let t,r=[];return Object.keys(e).forEach(s=>{switch(typeof(t=e[s])){case"string":case"number":case"boolean":r.push({property:s,eq:t});break;case"object":Array.isArray(t)?r.push({property:s,range:{from:t[0],to:t[1]}}):r.push(Object.assign({property:s},t));break;default:throw Error(`Unable to parse query "${t}"`)}}),r};var t={},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=r(e);t.default=class{constructor(e){this.m_max=-1,this.m_page=-1,this.orders=[],this.openDB=e.openDB,this.queries=s.default(e.queries),this.collection=e.collection}_openCursor(e,t,r){return new Promise((s,n)=>{let o=t.index(e).openCursor(r);var i={errors:[],items:[]};o.onsuccess=(e=>{var t=e.target.result;t?(i.items.push(t.value),t.continue()):s(i)}),o.onerror=(e=>{var t=e.target.result;t?(i.errors.push(t.value),t.continue()):s(i)})})}_openCursorMultipleRange(e,t,r,s){return new Promise(function(n,o){var i=[],a=0,c=r.length;r.forEach(r=>{let o=t.index(e).openCursor(r);o.onsuccess=(e=>(function(e){a===c&&n(i),i=s(i,e)})(e.target.result)),o.onerror=(e=>(function(e){console.error(e)})(e))})})}sort(){return this.orders=Array.prototype.slice.call(arguments),this}max(e){return this.m_max=e,this}paging(e,t){return this.m_page=e,this.m_max=t,this}run(){let e=this;return new Promise((t,r)=>{let s=0,n=e.queries.length,o=[],i=[];function a(){var e=new Array(o.length),r=new Array(o.length),s=0;o.forEach(t=>{-1==e.indexOf(t._id)&&(r[s]=t,e[s++]=t.key)}),r.splice(s),t({items:r,errors:i})}this.openDB(t=>{let r=t.transaction(e.collection,"readonly").objectStore(e.collection);e.queries.forEach(t=>{var c;if(t.eq)c=IDBKeyRange.only(t.eq);else if(t.range)c=IDBKeyRange.bound(t.range.from,t.range.to);else if(t.gt)c=IDBKeyRange.upperBound(t.gt,!1);else if(t.gte)c=IDBKeyRange.upperBound(t.gt,!0);else if(t.lt)c=IDBKeyRange.lowerBound(t.lt,!1);else{if(!t.lte)throw Error(`Unable to parse ${t}`);c=IDBKeyRange.lowerBound(t.lte,!0)}e._openCursor(t.property,r,c).then(e=>(function(e){Array.isArray(e.items)?o=o.concat(e.items):o.push(e.items),++s===n&&a()})(e)).catch(e=>{!function(e){s++,i.push(e),s===n&&a()}({property:t.property,message:e.message})})})})})}};var n={};Object.defineProperty(n,"__esModule",{value:!0}),n.default=class{constructor(){this.events={change:[]},this.triggerOnChangeEvent=(e=>{this.events.change.forEach(t=>{t.callback(e)})})}getEvents(){return this.events}subscribe(e,t,r=!1){if(this.events[e]||(this.events[e]=[]),r){const r=this.events.find(e=>e.id===t.id);-1!==r&&this.events[e].splice(r,1)}this.events[e].push(t)}fire(e,t){const r=this.events[e];r&&r.length&&r.forEach(r=>{r.callback&&r.callback(e,t)}),this.triggerOnChangeEvent({event:e,changed:t})}onChange(e){this.events.change.push(e)}};var o={},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(o,"__esModule",{value:!0});const a=i(n),c=i(t);o.default=class{constructor(e,t){this.openDB=t,this.ref=e,this.eventManager=new a.default}insert(e){let t=Array.isArray(e)?e:[e];var r=this;return new Promise((e,s)=>{r.openDB(n=>{var o,i=n.transaction(r.ref,"readwrite"),a=i.objectStore(r.ref);t.forEach(e=>{o=a.add(e)}),i.oncomplete=(s=>{var n={items:t,changes:{inserted:t.length,updated:0,removed:0,unchange:0}};r.eventManager.fire("insert",n),e(n)}),i.onerror=(e=>{s({items:t,message:o.error})})})})}remove(e){let t=[];t=Array.isArray(e)?e.map(e=>"string"==typeof e?e:e._id):"string"==typeof e?[e]:[e._id],Array.isArray(e);let r=this;return new Promise((e,s)=>{r.openDB(n=>{let o,i=n.transaction([r.ref],"readwrite"),a=i.objectStore(r.ref);t.forEach(e=>{o=a.delete(e)}),i.oncomplete=(s=>{const n={items:t,changes:{inserted:0,updated:0,removed:t.length,unchange:0}};r.eventManager.fire("remove",n),e(n)}),i.onerror=(e=>{s({items:t,message:o.error})})})})}update(e,t){let r=this;return new Promise((s,n)=>{r.openDB(o=>{let i=o.transaction([r.ref],"readwrite").objectStore(r.ref),a=i.get(e);a.onsuccess=function(o){var a=o.target.result;if(a){Object.assign(a,t);var c=i.put(a);c.onerror=(e=>n(e)),c.onsuccess=(n=>{var o={items:[{id:e,changes:t}],changes:{updated:1,inserted:0,removed:0,unchange:0}};r.eventManager.fire("update",o),s(o)})}else n({message:`Record "${e}" not existed`})},a.onerror=(e=>n(e))})})}openCursor(e){this.openDB(t=>{t.transaction(this.ref,"readonly").objectStore(this.ref).openCursor().onsuccess=(t=>{e(t.target.result)})})}filter(e){return new c.default({queries:e,openDB:this.openDB.bind(this),collection:this.ref})}records(){return new Promise((e,t)=>{this.openDB(r=>{var s=r.transaction(this.ref,"readonly").objectStore(this.ref).getAll();s.onsuccess=(t=>{e(t.target.result)}),s.onerror=(e=>{t({message:s.error})})})})}get(e){return new Promise((t,r)=>{this.openDB(s=>{var n=s.transaction(this.ref,"readonly").objectStore(this.ref).get(e);n.onsuccess=(e=>{t(e.target.result)}),n.onerror=(e=>{r({message:n.error})})})})}removeAllRecords(){return new Promise((e,t)=>{this.openDB(r=>{var s=r.transaction(this.ref,"readwrite").objectStore(this.ref),n=s.count(),o=s.clear();o.onsuccess=(t=>{var r={items:[],changes:{removed:s.indexNames.length,inserted:0,unchange:0,update:0}};this.eventManager.fire("remove",r),e(r)}),o.onerror=(e=>{t({items:[],message:o.error,changes:{removed:0,inserted:0,unchange:0,update:n}})})})})}subscribe(e,t){this.eventManager.subscribe(e,{callback:t})}on(e,t){this.eventManager.subscribe(e,{callback:t})}};var u={},d=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(u,"__esModule",{value:!0});const h=d(o),l=d(n),p="__clientdb_default";u.default=class{constructor(e){this.stores={},this.isOpening=!1,this.open=(e=>{this.db&&e(this.db);var t=!1;if(this.eventManager.subscribe("open",{callback:()=>{t||(e(this.db),t=!0)},once:!0}),!this.isOpening){let{name:e,version:t,onerror:s,onsuccess:n}=this.options;var r=indexedDB.open(e||p,t);this.request=r,r.onerror=s,r.onsuccess=(e=>{this.isOpening=!1,n(e.target.result)}),r.onupgradeneeded=this.onupgradeneeded}}),this.onerror=(e=>{this.options.onerror(this.request.error)}),this.upgrade=(()=>{let e=indexedDB.open(this.options.name,this.options.version+1);this.request=e,e.onerror=this.onerror,e.onsuccess=this.onsuccess,e.onupgradeneeded=this.onupgradeneeded}),this.onsuccess=(e=>{let t=e.target.result;if(this.request=void 0,!this.options.allowUpdate)return this.options.allowUpdate=!1,void this.options.onsuccess(t);t.close();let r=this.options.stores,s=!1;r.some(e=>void 0===t.objectStoreNames[e]&&(s=!0,!0)),s||(s=r.length!=t.objectStoreNames.length),s&&this.upgrade()}),this.onupgradeneeded=(e=>{let t=e.target.result,r=this.options.stores,s=Array.from(t.objectStoreNames);1===t.version?r.forEach(e=>{let r=t.createObjectStore(e.name,{keyPath:e.primaryKey||"_id"});Object.keys(e.keys).forEach(t=>{r.indexNames.contains(t)||r.createIndex(t,t,{unique:e.keys[t].unique})})}):(r.forEach(e=>{if(s.find(t=>e.name===t)){let r=t.createObjectStore(e.name,{keyPath:e.primaryKey||"_id"});Object.keys(e.keys).forEach(t=>{r.indexNames.contains(t)||r.createIndex(t,t,{unique:e.keys[t].unique})})}}),s.forEach(e=>{-1===r.indexOf(e)&&t.deleteObjectStore(e)})),this.db=t}),this.options=Object.assign({allowUpdate:!1,name:p,version:1,onerror:this._handleOpenFail.bind(this),onsuccess:this._handleOpenSuccess.bind(this)},e),this.options.stores.forEach(e=>{this.stores[e.name]=new h.default(e.name,this.open.bind(this))}),this.eventManager=new l.default;var t=indexedDB.open(this.options.name);this.request=t,t.onerror=this.onerror,t.onsuccess=this.onsuccess,t.onupgradeneeded=this.onupgradeneeded}_handleOpenFail(e){console.error(e.errorCode,"Unable to open database")}_handleOpenSuccess(e){this.db=e,this.options.version=e.version,this.request=void 0,this.eventManager.fire("open",null)}_handleStructureInitiate(e){if(e.target){var t=e.target.result;this.options.stores&&this.options.stores.forEach(r=>{let s;s=t.objectStoreNames.contains(r.name)?e.target.transaction.objectStore(r.name):t.createObjectStore(r.name,{keyPath:r.primaryKey||"_id"}),Object.keys(r.keys).forEach(e=>{s.indexNames.contains(e)||s.createIndex(e,e,{unique:r.keys[e].unique})})})}}removeStore(e){var t=this;return new Promise((r,s)=>{t.open(n=>{let{name:o,version:i}=t.options;var a=indexedDB.open(o||p,i+1);a.onerror=function(e){s(a.error)},a.onsuccess=(t=>{n=t.target.result,delete this.stores[e],r(n)}),a.onupgradeneeded=function(t){n.deleteObjectStore(e)}})})}createStore(e,t){var r=this;return new Promise((s,n)=>{let o=r.options.stores.find(t=>t.name===e);r.open(i=>{var a=indexedDB.open(i.name,i.version+1);a.onerror=function(e){n(a.error)},a.onsuccess=(t=>{r.db=t.target.result,this.stores[e]=new h.default(e,this.open.bind(this)),s(i)}),a.onupgradeneeded=function(r){let s=i.createObjectStore(e,{keyPath:o.primaryKey||"_id"});Object.keys(t).forEach(e=>{s.createIndex(e,e,{unique:t[e].unique})})}})})}updateKeys(e,t){var r=this;return this.db&&this.db.close(),new Promise((s,n)=>{r.open(o=>{var i=indexedDB.open(o.name,o.version+1);i.onerror=function(e){n({message:i.error})},i.onsuccess=(e=>{r.db=e.target.result,s(r.db)}),i.onupgradeneeded=function(r){let s=r.target.transaction.objectStore(e);s||n({message:`Collection ${e} not exists, use ".createStore(storeName, keys)" instead`}),Array.from(s.indexNames).forEach(e=>{t[e]||s.deleteIndex(e)}),Object.keys(t).forEach(e=>{s.indexNames.contains(e)||s.createIndex(e,e,{unique:t[e].unique})})}})})}collect(e){return this.stores[e]}destroy(){indexedDB.deleteDatabase(this.options.name||p)}};var f={},g=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(f,"__esModule",{value:!0});const m=g(u);f.default=m.default;var v=f.default;window.ClientDB=v}();