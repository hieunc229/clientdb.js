!function(){var e={};Object.defineProperty(e,"__esModule",{value:!0}),e.default=function(e){let t,r=[];return Object.keys(e).forEach(s=>{switch(typeof(t=e[s])){case"string":case"number":case"boolean":r.push({property:s,eq:t});break;case"object":Array.isArray(t)?r.push({property:s,range:{from:t[0],to:t[1]}}):r.push(Object.assign({property:s},t));break;default:throw Error(`Unable to parse query "${t}"`)}}),r};var t={},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=r(e);t.default=class{constructor(e){this.m_max=-1,this.m_page=-1,this.orders=[],this.openDB=e.openDB,this.queries=s.default(e.queries),this.collection=e.collection}_openCursor(e,t,r){return new Promise((s,n)=>{let o=t.index(e).openCursor(r);var i={errors:[],items:[]};o.onsuccess=(e=>{var t=e.target.result;t?(i.items.push(t.value),t.continue()):s(i)}),o.onerror=(e=>{var t=e.target.result;t?(i.errors.push(t.value),t.continue()):s(i)})})}_openCursorMultipleRange(e,t,r,s){return new Promise(function(n,o){var i=[],a=0,c=r.length;r.forEach(r=>{let o=t.index(e).openCursor(r);o.onsuccess=(e=>(function(e){a===c&&n(i),i=s(i,e)})(e.target.result)),o.onerror=(e=>(function(e){console.error(e)})(e))})})}sort(){return this.orders=Array.prototype.slice.call(arguments),this}max(e){return this.m_max=e,this}paging(e,t){return this.m_page=e,this.m_max=t,this}run(){let e=this;return new Promise((t,r)=>{let s=0,n=e.queries.length,o=[],i=[];function a(){var e=new Array(o.length),r=new Array(o.length),s=0;o.forEach(t=>{-1==e.indexOf(t._id)&&(r[s]=t,e[s++]=t.key)}),r.splice(s),t({items:r,errors:i})}this.openDB(t=>{let r=t.transaction(e.collection,"readonly").objectStore(e.collection);e.queries.forEach(t=>{var c;if(t.eq)c=IDBKeyRange.only(t.eq);else if(t.range)c=IDBKeyRange.bound(t.range.from,t.range.to);else if(t.gt)c=IDBKeyRange.upperBound(t.gt,!1);else if(t.gte)c=IDBKeyRange.upperBound(t.gt,!0);else if(t.lt)c=IDBKeyRange.lowerBound(t.lt,!1);else{if(!t.lte)throw Error(`Unable to parse ${t}`);c=IDBKeyRange.lowerBound(t.lte,!0)}e._openCursor(t.property,r,c).then(e=>(function(e){Array.isArray(e.items)?o=o.concat(e.items):o.push(e.items),++s===n&&a()})(e)).catch(e=>{!function(e){s++,i.push(e),s===n&&a()}({property:t.property,message:e.message})})})})})}};var n={};Object.defineProperty(n,"__esModule",{value:!0}),n.default=class{constructor(){this.events={change:[]},this.triggerOnChangeEvent=(e=>{this.events.change.forEach(t=>{t.callback(e)})})}getEvents(){return this.events}subscribe(e,t,r=!1){if(this.events[e]||(this.events[e]=[]),r){const r=this.events.find(e=>e.id===t.id);-1!==r&&this.events[e].splice(r,1)}this.events[e].push(t)}fire(e,t){const r=this.events[e];r&&r.length&&r.forEach(r=>{r.callback&&r.callback(e,t)}),this.triggerOnChangeEvent({event:e,changed:t})}onChange(e){this.events.change.push(e)}};var o={},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(o,"__esModule",{value:!0});const a=i(n),c=i(t);o.default=class{constructor(e,t){this.openDB=t,this.ref=e,this.eventManager=new a.default}insert(e){let t=Array.isArray(e)?e:[e];var r=this;return new Promise((e,s)=>{r.openDB((n,o)=>{var i=n.transaction(r.ref,"readwrite"),a=i.objectStore(r.ref);t.forEach(e=>{a.add(e)}),i.oncomplete=(s=>{var n={items:t,changes:{inserted:t.length,updated:0,removed:0,unchange:0}};r.eventManager.fire("insert",n),e(n),o()}),i.onerror=(e=>{s({items:t,message:i.error})})})})}remove(e){let t=[];t=Array.isArray(e)?e.map(e=>"string"==typeof e?e:e._id):"string"==typeof e?[e]:[e._id],Array.isArray(e);let r=this;return new Promise((e,s)=>{r.openDB((n,o)=>{let i,a=n.transaction([r.ref],"readwrite"),c=a.objectStore(r.ref);t.forEach(e=>{i=c.delete(e)}),a.oncomplete=(s=>{const n={items:t,changes:{inserted:0,updated:0,removed:t.length,unchange:0}};r.eventManager.fire("remove",n),e(n),o()}),a.onerror=(e=>{s({items:t,message:i.error})})})})}update(e,t){let r=this;return new Promise((s,n)=>{r.openDB((o,i)=>{let a=o.transaction([r.ref],"readwrite").objectStore(r.ref),c=a.get(e);c.onsuccess=function(o){var c=o.target.result;if(c){Object.assign(c,t);var u=a.put(c);u.onerror=(e=>n(e)),u.onsuccess=(n=>{var o={items:[{id:e,changes:t}],changes:{updated:1,inserted:0,removed:0,unchange:0}};r.eventManager.fire("update",o),s(o),i()})}else n({message:`Record "${e}" not existed`})},c.onerror=(e=>{n(c.error)})})})}openCursor(e){this.openDB((t,r)=>{t.transaction(this.ref,"readonly").objectStore(this.ref).openCursor().onsuccess=(r=>{e(r.target.result,t)})})}filter(e){return new c.default({queries:e,openDB:this.openDB.bind(this),collection:this.ref})}records(){return new Promise((e,t)=>{this.openDB((r,s)=>{var n=r.transaction(this.ref,"readonly").objectStore(this.ref).getAll();n.onsuccess=(t=>{let r=t.target.result;e(r),s()}),n.onerror=(e=>{t({message:n.error})})})})}get(e){return new Promise((t,r)=>{this.openDB((s,n)=>{var o=s.transaction(this.ref,"readonly").objectStore(this.ref).get(e);o.onsuccess=(e=>{let r=e.target.result;t(r),n()}),o.onerror=(e=>{r({message:o.error})})})})}getAll(e){return new Promise((t,r)=>{this.openDB((s,n)=>{var o,i=s.transaction(this.ref,"readonly").objectStore(this.ref).openCursor(),a=[];i.onsuccess=(r=>{(o=r.target.result)?(-1!==e.indexOf(o.key)&&a.push(o.value),o.continue()):(t(a),n())}),i.onerror=(e=>{r({message:i.error})})})})}removeAllRecords(){return new Promise((e,t)=>{this.openDB((r,s)=>{var n=r.transaction(this.ref,"readwrite").objectStore(this.ref),o=n.count(),i=n.clear();i.onsuccess=(t=>{var r={items:[],changes:{removed:n.indexNames.length,inserted:0,unchange:0,update:0}};this.eventManager.fire("remove",r),e(r),s()}),i.onerror=(e=>{t({items:[],message:i.error,changes:{removed:0,inserted:0,unchange:0,update:o}})})})})}subscribe(e,t){this.eventManager.subscribe(e,{callback:t})}on(e,t){this.eventManager.subscribe(e,{callback:t})}};var u={},h=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(u,"__esModule",{value:!0});const l=h(o),d=h(n),p="__clientdb_default";u.default=class{constructor(e){this.stores={},this.__openConnections=0,this._handleOpenFail=(e=>{console.error(e.errorCode,this.request.error,"Unable to open database"),this.request=void 0}),this._handleOpenSuccess=(e=>{this.options.version=e.version,this.request=void 0,this.eventManager.fire("open",{db:e})}),this._handleStructureInitiate=(e=>{if(e.target){var t=e.target.result;this.options.stores&&this.options.stores.forEach(r=>{let s;s=t.objectStoreNames.contains(r.name)?e.target.transaction.objectStore(r.name):t.createObjectStore(r.name,{keyPath:r.primaryKey||"_id"}),Object.keys(r.keys).forEach(e=>{s.indexNames.contains(e)||s.createIndex(e,e,{unique:r.keys[e].unique})})})}}),this.isOpening=!1,this.closeConnection=(()=>{0===this.__openConnections&&this.db&&(this.db.close(),this.db=void 0)}),this.open=(e=>{var t=!1;if(this.db)e(this.db,this.closeConnection);else{this.__openConnections++;let s=this;if(this.eventManager.subscribe("open",{callback:(r,n)=>{t||(this.__openConnections--,s.db=n.db,e(s.db,this.closeConnection),t=!0)},once:!0}),!this.isOpening){let{name:e,onerror:t,onsuccess:s}=this.options,n=this.options.version>1?this.options.version:void 0;var r=indexedDB.open(e||p,n);this.request=r,r.onerror=function(e){t({message:r.error})},r.onsuccess=(e=>{this.isOpening=!1,s(e.target.result),e.target.result.close()}),r.onupgradeneeded=this.onupgradeneeded,r.onblocked=(e=>{console.warn("Open DB blocked")})}}}),this.updateKeys=((e,t)=>{var r=this;return new Promise((s,n)=>{var o=indexedDB.open(r.options.name,r.options.version+1);r.request=o,o.onerror=function(e){n({message:o.error})},o.onblocked=(e=>{console.warn("Operation is blocked"),r.db&&r.db.close()}),o.onsuccess=(e=>{this.options.version=e.target.result.version,e.target.result.close(),s()}),o.onupgradeneeded=function(r){let s=r.target.transaction.objectStore(e);s||n({message:`Collection ${e} not exists, use ".createStore(storeName, keys)" instead`}),Array.from(s.indexNames).forEach(e=>{t[e]||s.deleteIndex(e)}),Object.keys(t).forEach(e=>{s.indexNames.contains(e)||s.createIndex(e,e,{unique:t[e].unique})})}})}),this.onerror=(e=>{this.options.onerror(this.request.error)}),this.upgrade=(()=>{let e=indexedDB.open(this.options.name,this.options.version+1);this.request=e,e.onerror=this.onerror,e.onsuccess=this.onsuccess,e.onupgradeneeded=this.onupgradeneeded}),this.onsuccess=(e=>{let t=e.target.result;if(this.request=void 0,!this.options.allowUpdate)return this.options.allowUpdate=!1,void this.options.onsuccess(t);t.close();let r=this.options.stores,s=!1;r.some(e=>void 0===t.objectStoreNames[e]&&(s=!0,!0)),s||(s=r.length!=t.objectStoreNames.length),s&&this.upgrade()}),this.onupgradeneeded=(e=>{let t=e.target.result,r=this.options.stores,s=Array.from(t.objectStoreNames);1===t.version?r.forEach(e=>{let r=t.createObjectStore(e.name,{keyPath:e.primaryKey||"_id"});Object.keys(e.keys).forEach(t=>{r.indexNames.contains(t)||r.createIndex(t,t,{unique:e.keys[t].unique})})}):(r.forEach(e=>{if(s.find(t=>e.name===t)){let r=t.createObjectStore(e.name,{keyPath:e.primaryKey||"_id"});Object.keys(e.keys).forEach(t=>{r.indexNames.contains(t)||r.createIndex(t,t,{unique:e.keys[t].unique})})}}),s.forEach(e=>{-1===r.indexOf(e)&&t.deleteObjectStore(e)}))}),this.options=Object.assign({allowUpdate:!1,name:p,version:1,onerror:this._handleOpenFail,onsuccess:this._handleOpenSuccess},e),this.options.stores.forEach(e=>{this.stores[e.name]=new l.default(e.name,this.open.bind(this))}),this.eventManager=new d.default;var t=indexedDB.open(this.options.name);this.request=t,t.onerror=this.onerror,t.onsuccess=this.onsuccess,t.onupgradeneeded=this.onupgradeneeded}removeStore(e){var t=this;return new Promise((r,s)=>{t.open((n,o)=>{let{name:i,version:a}=t.options;var c=indexedDB.open(i||p,a+1);this.request=c,c.onerror=function(e){s(c.error)},c.onsuccess=(t=>{t.target.result.close(),delete this.stores[e],r(),o()}),c.onupgradeneeded=function(t){n.deleteObjectStore(e)}})})}createStore(e,t){var r=this;return new Promise((s,n)=>{let o=r.options.stores.find(t=>t.name===e);r.open((r,i)=>{var a=indexedDB.open(r.name,r.version+1);this.request=a,a.onerror=function(e){n(a.error)},a.onsuccess=(t=>{t.target.result.close(),this.stores[e]=new l.default(e,this.open.bind(this)),s(),i()}),a.onupgradeneeded=function(s){let n=r.createObjectStore(e,{keyPath:o.primaryKey||"_id"});Object.keys(t).forEach(e=>{n.createIndex(e,e,{unique:t[e].unique})})}})})}collect(e){return this.stores[e]}destroy(){indexedDB.deleteDatabase(this.options.name||p)}};var f={},g=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(f,"__esModule",{value:!0});const m=g(u);f.default=m.default;var v=f.default;window.ClientDB=v}();